name: ğŸš€ Deploy PHP App to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: ğŸš€ Deploy Application
      run: |
        echo "ğŸ“¤ Copiando archivos al servidor..."
        
        # Copiar APP PHP al servidor
        scp -r -o StrictHostKeyChecking=no ./app/* ${{ secrets.SSH_USER }}@62.171.169.111:/root/appPHP/
        
        # Copiar NGINX PROXY al servidor
        scp -r -o StrictHostKeyChecking=no ./nginx-proxy/* ${{ secrets.SSH_USER }}@62.171.169.111:/root/ngix-proxy/
        
        # Ejecutar despliegue en el servidor
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@62.171.169.111 << 'EOF'
        set -e
        
        echo "ğŸ”¨ Reconstruyendo aplicaciÃ³n PHP..."
        cd /root/appPHP
        docker build -t mi-app-php .
        
        echo "ğŸ›‘ Deteniendo contenedor antiguo..."
        docker stop aplicacion 2>/dev/null || true
        docker rm aplicacion 2>/dev/null || true
        
        echo "ğŸ³ Iniciando nuevo contenedor PHP..."
        docker run -d --name aplicacion -p 80:80 mi-app-php
        
        echo "ğŸ”„ Actualizando Nginx Proxy..."
        cd /root/ngix-proxy
        docker-compose down
        docker-compose up -d --build
        
        echo "ğŸ”— Conectando servicios a la red..."
        docker network connect app-network aplicacion 2>/dev/null || echo "âš ï¸  La red app-network podrÃ­a no existir"
        
        echo "âœ… Verificando despliegue..."
        sleep 15
        echo "ğŸ“Š Estado de contenedores:"
        docker ps
        echo "ğŸŒ Probando la aplicaciÃ³n..."
        curl -f https://brainsync.colibrihub.com:8443 && echo "ğŸ‰ Â¡Despliegue exitoso!" || echo "âš ï¸  La aplicaciÃ³n podrÃ­a estar iniciando..."
        
        echo "=========================================="
        echo "ğŸš€ DESPLIEGUE COMPLETADO"
        echo "ğŸ“± App disponible en: https://brainsync.colibrihub.com:8443"
        echo "=========================================="
        EOF