name: üöÄ Deploy Full Stack App to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3

    - name: üîë Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: üöÄ Deploy Full Stack Application
      run: |
        set -e
        echo "üîß Configurando SSH..."

        # Agregar el host a known_hosts
        mkdir -p ~/.ssh
        ssh-keyscan -H 62.171.169.111 >> ~/.ssh/known_hosts

        echo "üì§ Copiando archivos al servidor..."

        # Copiar APP PHP
        scp -r -o StrictHostKeyChecking=no ./app/* root@62.171.169.111:/root/appPHP/

        # Copiar SPRING BOOT
        scp -r -o StrictHostKeyChecking=no ./mi-cliente/* root@62.171.169.111:/root/appPHP/mi-cliente/

        # Copiar NOTIFICATION ‚Üê NUEVO
        scp -r -o StrictHostKeyChecking=no ./mi-notificacion/* root@62.171.169.111:/root/appPHP/mi-notificacion/

        # Copiar NGINX PROXY
        scp -r -o StrictHostKeyChecking=no ./nginx-proxy/* root@62.171.169.111:/root/ngix-proxy/

        echo "üéØ Ejecutando despliegue en el servidor..."
        ssh -o StrictHostKeyChecking=no root@62.171.169.111 << 'EOF'
        set -e

        echo "üî® Reconstruyendo aplicaci√≥n PHP..."
        cd /root/appPHP
        docker build -t mi-app-php .

        echo "üî® Construyendo aplicaci√≥n Spring Boot..."
        cd /root/appPHP/mi-cliente
        chmod +x gradlew
        ./gradlew build -x test
        docker build -t mi-cliente .

        echo "üì® Construyendo aplicaci√≥n Notification..." ‚Üê NUEVO
        cd /root/appPHP/mi-notificacion
        # Si usa Maven
        if [ -f "pom.xml" ]; then
            mvn clean package -DskipTests
        # Si usa Gradle  
        elif [ -f "build.gradle" ]; then
            chmod +x gradlew
            ./gradlew build -x test
        fi
        docker build -t mi-notificacion .

        echo "üõë Deteniendo contenedores antiguos..."
        docker stop aplicacion 2>/dev/null || true
        docker rm aplicacion 2>/dev/null || true
        docker stop mi-cliente 2>/dev/null || true
        docker rm mi-cliente 2>/dev/null || true
        docker stop mi-notificacion 2>/dev/null || true ‚Üê NUEVO
        docker rm mi-notificacion 2>/dev/null || true ‚Üê NUEVO

        echo "üê≥ Iniciando nuevo contenedor PHP..."
        docker run -d --name aplicacion -p 80:80 mi-app-php

        echo "‚òï Iniciando nuevo contenedor Spring Boot..."
        docker run -d \
          --name mi-cliente \
          -p 8090:8090 \
          --network bridge \
          -e SPRING_DATASOURCE_URL="jdbc:mysql://172.17.0.5:3306/clientesdb?allowPublicKeyRetrieval=true&useSSL=false" \
          -e SPRING_DATASOURCE_USERNAME=root \
          -e SPRING_DATASOURCE_PASSWORD=cruz123 \
          -e SPRING_JPA_HIBERNATE_DDL_AUTO=update \
          mi-cliente

        echo "üì® Iniciando nuevo contenedor Notification..." ‚Üê NUEVO
        docker run -d \
          --name mi-notificacion \
          -p 8091:8091 \
          --network bridge \
          -e SPRING_DATASOURCE_URL="jdbc:mysql://172.17.0.5:3306/clientesdb?allowPublicKeyRetrieval=true&useSSL=false" \
          -e SPRING_DATASOURCE_USERNAME=root \
          -e SPRING_DATASOURCE_PASSWORD=cruz123 \
          mi-notificacion

        echo "üîß Actualizando Nginx Proxy..."
        cd /root/ngix-proxy
        docker-compose down 2>/dev/null || true
        docker-compose up -d --build

        echo "‚è≥ Esperando que los servicios est√©n listos..."
        sleep 30

        echo "üìä Verificando despliegue..."
        docker ps
        echo "‚úÖ PHP App desplegada en: https://brainsync.colibrihub.com:8443"
        echo "‚úÖ Spring Boot desplegada en: http://62.171.169.111:8090"
        echo "‚úÖ Notification Service desplegada en: http://62.171.169.111:8091" ‚Üê NUEVO
        EOF

        echo "üéâ ¬°Despliegue completo exitoso!"